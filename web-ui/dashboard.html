<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Gateway — Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1419;
            --surface: #1a2332;
            --surface-hover: #243044;
            --border: #2d3a4d;
            --text: #e6edf3;
            --text-muted: #8b949e;
            --accent: #58a6ff;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --radius: 10px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding: 20px 24px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }
        .header h1 { font-size: 1.5rem; font-weight: 600; display: flex; align-items: center; gap: 12px; }
        .header p { color: var(--text-muted); font-size: 0.9rem; margin-top: 4px; }
        .icon { width: 20px; height: 20px; flex-shrink: 0; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .icon-sm { width: 16px; height: 16px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: border-color 0.2s;
        }
        .stat-card:hover { border-color: var(--accent); }
        .stat-number { font-size: 2rem; font-weight: 700; }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-top: 4px; }
        .stat-card.running .stat-number { color: var(--success); }
        .stat-card.stopped .stat-number { color: var(--danger); }
        .stat-card.deploying .stat-number { color: var(--warning); }
        .stat-card.total .stat-number { color: var(--accent); }
        .main-content { display: grid; grid-template-columns: 1fr 280px; gap: 24px; }
        .panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
        }
        .panel-title { font-size: 1rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .card {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        .card:hover { border-color: var(--surface-hover); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .card-title { font-weight: 600; font-size: 1rem; }
        .badge {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 4px 10px;
            border-radius: 999px;
        }
        .badge-running { background: rgba(63, 185, 80, 0.2); color: var(--success); }
        .badge-stopped { background: rgba(248, 81, 73, 0.2); color: var(--danger); }
        .badge-deploying { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
        .badge-runtime { background: rgba(88, 166, 255, 0.15); color: var(--accent); font-size: 0.65rem; margin-left: 6px; }
        .card-meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 12px; font-size: 0.85rem; }
        .card-meta dt { color: var(--text-muted); font-weight: 500; }
        .card-meta dd { margin-top: 2px; }
        .btn-row { display: flex; flex-wrap: wrap; gap: 8px; }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-family: inherit;
            transition: opacity 0.2s, transform 0.1s;
        }
        .btn:hover { opacity: 0.9; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-warning { background: var(--warning); color: #0f1419; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-ghost { background: var(--surface-hover); color: var(--text); }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 6px; color: var(--text-muted); }
        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
            font-family: inherit;
        }
        .form-input:focus { outline: none; border-color: var(--accent); }
        .log-viewer {
            background: #0d1117;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            height: 320px;
            overflow: auto;
            color: #c9d1d9;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-viewer.empty { color: var(--text-muted); }
        .section-logs { margin-top: 24px; }
        .section-logs .panel-title { margin-bottom: 12px; }
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 24px;
        }
        .modal-overlay.hidden { display: none; }
        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            width: 100%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-title { font-weight: 600; font-size: 1.1rem; }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        .modal-close:hover { color: var(--text); background: var(--surface-hover); }
        .modal-body {
            padding: 20px;
            overflow: auto;
            flex: 1;
        }
        .modal-body .log-viewer { height: 360px; }
        .modal-footer { padding: 12px 20px; border-top: 1px solid var(--border); text-align: right; }
        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast {
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: toastIn 0.25s ease;
        }
        .toast.success { background: var(--success); color: #fff; }
        .toast.error { background: var(--danger); color: #fff; }
        .toast.info { background: var(--accent); color: #fff; }
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .empty-state { text-align: center; padding: 48px 24px; color: var(--text-muted); }
        .empty-state h3 { color: var(--text); font-size: 1.1rem; margin-bottom: 8px; }
        .empty-state p { font-size: 0.9rem; margin-bottom: 16px; }
        .pulse { animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%,100%{ opacity: 1; } 50%{ opacity: 0.6; } }
        @media (max-width: 900px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .main-content { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>

    <div class="container">
        <div class="header">
            <div>
                <h1>
                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/></svg>
                    <a href="/" style="color:inherit;text-decoration:none">API Gateway</a>
                </h1>
                <p>Deployments and services · live via Server-Sent Events</p>
            </div>
            <div style="display:flex;gap:8px;">
                <a href="/" style="padding:8px 14px;background:var(--surface-hover);color:var(--text);text-decoration:none;border-radius:6px;font-size:0.9rem;">Home</a>
                <a href="/observe/" target="_blank" style="padding:8px 14px;background:var(--surface-hover);color:var(--text);text-decoration:none;border-radius:6px;font-size:0.9rem;">OpenObserve</a>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card running">
                <div class="stat-number" id="running-count">0</div>
                <div class="stat-label">Running</div>
            </div>
            <div class="stat-card stopped">
                <div class="stat-number" id="stopped-count">0</div>
                <div class="stat-label">Stopped</div>
            </div>
            <div class="stat-card deploying">
                <div class="stat-number" id="deploying-count">0</div>
                <div class="stat-label">Deploying</div>
            </div>
            <div class="stat-card total">
                <div class="stat-number" id="total-count">0</div>
                <div class="stat-label">Total</div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <div class="panel-title">
                    <svg class="icon" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                    Deployments
                </div>
                <div id="deployments-list"></div>
            </div>
            <div class="panel">
                <div class="panel-title">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                    Actions
                </div>
                <div class="form-group">
                    <button class="btn btn-ghost" style="width:100%;" onclick="refreshData()">
                        <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                        Refresh now
                    </button>
                </div>
                <div class="form-group">
                    <button class="btn btn-success" style="width:100%;" onclick="showAddDeploymentForm()">
                        <svg class="icon icon-sm" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add deployment
                    </button>
                </div>
                <div class="form-group">
                    <label class="form-label">Service logs</label>
                    <select class="form-input" id="log-service-select">
                        <option value="">Select service...</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn btn-warning" style="width:100%;" onclick="showSystemInfo()">
                        <svg class="icon icon-sm" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                        System info
                    </button>
                </div>
                <hr style="border-color:var(--border);margin:12px 0;">
                <div class="panel-title" style="font-size:0.85rem;">
                    <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M12 2a4 4 0 0 0-4 4v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2h-2V6a4 4 0 0 0-4-4z"/></svg>
                    AI Models
                </div>
                <div id="ai-services-list" style="font-size:0.85rem;color:var(--text-muted);margin-bottom:8px;">Loading...</div>
                <div class="form-group">
                    <button class="btn btn-ghost" style="width:100%;font-size:0.8rem;" onclick="showAiHelp()">
                        Install AI model via CLI
                    </button>
                </div>
            </div>
        </div>

        <div class="section-logs panel">
            <div class="panel-title">
                <svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
                Service logs
                <span id="log-live-badge" style="margin-left:8px;font-size:0.7rem;color:var(--text-muted);font-weight:400;"></span>
            </div>
            <div class="log-viewer empty" id="log-viewer">Select a service to stream logs.</div>
        </div>
    </div>

    <!-- Deploy progress modal -->
    <div class="modal-overlay hidden" id="deploy-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="deploy-modal-title">Deploying…</span>
                <button class="modal-close" onclick="closeDeployModal()" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="deploy-log-toolbar" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
                    <label class="form-label" style="margin:0;">Deploy:</label>
                    <select id="deploy-history-select" class="form-select" style="min-width:180px;" onchange="onDeployHistorySelect()">
                        <option value="latest">Current (live)</option>
                    </select>
                    <span class="badge badge-running" id="deploy-live-badge" style="display:none;">Live</span>
                </div>
                <div class="log-viewer" id="deploy-log-viewer">Starting deployment…</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" id="deploy-modal-close-btn" onclick="closeDeployModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Webhook instructions modal -->
    <div class="modal-overlay hidden" id="webhook-modal">
        <div class="modal" style="max-width: 640px;">
            <div class="modal-header">
                <span class="modal-title" id="webhook-modal-title">GitHub Webhook Setup</span>
                <button class="modal-close" onclick="closeWebhookModal()" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="log-viewer" style="height: 420px; overflow: auto; white-space: pre-wrap; font-size: 0.85rem;" id="webhook-instructions">Loading…</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="copyWebhookInstructions()">Copy all</button>
                <button class="btn btn-ghost" onclick="closeWebhookModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API = '/gateway-api';
        let deployments = {};
        let deploymentsEventSource;
        let logsEventSource;
        let deployLogEventSource;

        function showToast(message, type = 'info') {
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.textContent = message;
            document.getElementById('toast-container').appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        function formatDate(dateString) {
            if (!dateString || dateString === 'Never') return 'Never';
            try {
                return new Date(dateString).toLocaleString();
            } catch {
                return dateString;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            startDeploymentsSSE();
            refreshData();
        });

        function startDeploymentsSSE() {
            if (deploymentsEventSource) deploymentsEventSource.close();
            deploymentsEventSource = new EventSource(API + '/sse/deployments');
            deploymentsEventSource.addEventListener('deployments', function(e) {
                try {
                    const data = JSON.parse(e.data);
                    if (data.deployments) {
                        const prev = deployments;
                        deployments = data.deployments;
                        updateDeploymentsList();
                        updateStats();
                        updateServiceSelect();
                        const logService = document.getElementById('log-service-select').value;
                        if (logService && logsEventSource) {
                            const wasDeploying = prev[logService]?.status === 'deploying';
                            const nowNotDeploying = (deployments[logService]?.status || '') !== 'deploying';
                            if (wasDeploying && nowNotDeploying) {
                                startLogStream();
                            }
                        }
                    }
                } catch (_) {}
            });
            deploymentsEventSource.addEventListener('error', function() {
                deploymentsEventSource.close();
                setTimeout(startDeploymentsSSE, 3000);
            });
        }

        async function refreshData(silent = true) {
            try {
                const res = await fetch(API + '/deployments');
                const data = await res.json();
                deployments = data.deployments || {};
                updateDeploymentsList();
                updateStats();
                updateServiceSelect();
            } catch (e) {
                if (!silent) showToast('Failed to load deployments', 'error');
            }
        }

        function updateDeploymentsList() {
            const container = document.getElementById('deployments-list');
            if (Object.keys(deployments).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No deployments</h3>
                        <p>Add a deployment to get started.</p>
                        <button class="btn btn-primary" onclick="showAddDeploymentForm()">Add deployment</button>
                    </div>`;
                return;
            }
            let html = '';
            for (const [name, d] of Object.entries(deployments)) {
                const cfg = d.config || {};
                const status = d.status || 'unknown';
                const runtime = cfg.runtime || 'auto';
                const runtimeLabel = runtime === 'auto' ? '' : runtime;
                html += `
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">${escapeHtml(name)}${runtimeLabel ? `<span class="badge badge-runtime">${escapeHtml(runtimeLabel)}</span>` : ''}</span>
                            <span class="badge badge-${status}">${status}</span>
                        </div>
                        <dl class="card-meta">
                            <div><dt>Repo</dt><dd>${escapeHtml((cfg.github_repo || '—').split('/').pop())}</dd></div>
                            <div><dt>Branch</dt><dd>${cfg.branch || 'main'}</dd></div>
                            <div><dt>Port</dt><dd>${cfg.port || '—'}</dd></div>
                            <div><dt>Updated</dt><dd>${formatDate(d.last_updated)}</dd></div>
                        </dl>
                        <div class="btn-row">
                            <button class="btn btn-success" onclick="deployService('${escapeHtml(name)}')">
                                <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M15 3v4a2 2 0 0 0 2 2h4"/><path d="M10 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9"/><path d="M10 12h4"/><path d="M10 16h4"/></svg>
                                Deploy
                            </button>
                            <button class="btn btn-primary" onclick="viewDeployLogs('${escapeHtml(name)}')" title="Deploy history and live log">
                                <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                                Deploy logs
                            </button>
                            <button class="btn btn-primary" onclick="viewLogs('${escapeHtml(name)}')">
                                <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                                Logs
                            </button>
                            <button class="btn btn-warning" onclick="showWebhookInstructions('${escapeHtml(name)}')" title="Webhook setup">
                                <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                                Webhook
                            </button>
                            <button class="btn btn-warning" onclick="restartService('${escapeHtml(name)}')">
                                <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                                Restart
                            </button>
                            <button class="btn btn-danger" onclick="removeDeployment('${escapeHtml(name)}')">
                                <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                Remove
                            </button>
                        </div>
                    </div>`;
            }
            container.innerHTML = html;
        }

        function escapeHtml(s) {
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function showEmptyState() {
            document.getElementById('deployments-list').innerHTML = `
                <div class="empty-state">
                    <h3>No deployments</h3>
                    <button class="btn btn-primary" onclick="showAddDeploymentForm()">Add deployment</button>
                </div>`;
        }

        function updateStats() {
            let running = 0, stopped = 0, deploying = 0;
            Object.values(deployments).forEach(d => {
                const s = d.status || 'stopped';
                if (s === 'running') running++;
                else if (s === 'deploying') deploying++;
                else stopped++;
            });
            document.getElementById('running-count').textContent = running;
            document.getElementById('stopped-count').textContent = stopped;
            document.getElementById('deploying-count').textContent = deploying;
            document.getElementById('total-count').textContent = Object.keys(deployments).length;
        }

        function updateServiceSelect() {
            const sel = document.getElementById('log-service-select');
            const cur = sel.value;
            sel.innerHTML = '<option value="">Select service...</option>';
            Object.keys(deployments).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                sel.appendChild(opt);
            });
            if (cur && deployments[cur]) sel.value = cur;
        }

        let deployModalServiceName = '';

        function openDeployModal(serviceName) {
            deployModalServiceName = serviceName;
            document.getElementById('deploy-modal-title').textContent = `Deploy logs: ${serviceName}`;
            document.getElementById('deploy-log-viewer').textContent = 'Connecting to log stream…';
            document.getElementById('deploy-modal').classList.remove('hidden');
            document.getElementById('deploy-live-badge').style.display = 'inline';
            loadDeployHistorySelect(serviceName).then(() => {
                document.getElementById('deploy-history-select').value = 'latest';
            });
        }

        async function loadDeployHistorySelect(serviceName) {
            const sel = document.getElementById('deploy-history-select');
            sel.innerHTML = '<option value="latest">Current (live)</option>';
            try {
                const res = await fetch(API + '/deployments/' + encodeURIComponent(serviceName) + '/deploy-log-files');
                const list = await res.json();
                list.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.filename;
                    opt.textContent = item.label;
                    sel.appendChild(opt);
                });
            } catch (_) {}
        }

        async function onDeployHistorySelect() {
            const sel = document.getElementById('deploy-history-select');
            const value = sel.value;
            const viewer = document.getElementById('deploy-log-viewer');
            const badge = document.getElementById('deploy-live-badge');
            if (value === 'latest') {
                if (deployLogEventSource) deployLogEventSource.close();
                deployLogEventSource = null;
                viewer.textContent = 'Connecting to log stream…';
                badge.style.display = 'inline';
                startDeployLogSSE(deployModalServiceName);
            } else {
                if (deployLogEventSource) {
                    deployLogEventSource.close();
                    deployLogEventSource = null;
                }
                badge.style.display = 'none';
                viewer.textContent = 'Loading…';
                try {
                    const res = await fetch(API + '/deployments/' + encodeURIComponent(deployModalServiceName) + '/deploy-log-content/' + encodeURIComponent(value));
                    viewer.textContent = await res.text() || '(empty)';
                } catch (e) {
                    viewer.textContent = 'Failed to load log.';
                }
                viewer.scrollTop = viewer.scrollHeight;
            }
        }

        function closeDeployModal() {
            document.getElementById('deploy-modal').classList.add('hidden');
            if (deployLogEventSource) {
                deployLogEventSource.close();
                deployLogEventSource = null;
            }
        }

        let webhookInstructionsText = '';
        async function showWebhookInstructions(serviceName) {
            document.getElementById('webhook-modal-title').textContent = `Webhook: ${serviceName}`;
            document.getElementById('webhook-instructions').textContent = 'Loading…';
            document.getElementById('webhook-modal').classList.remove('hidden');
            try {
                const res = await fetch(API + '/deployments/' + encodeURIComponent(serviceName) + '/webhook-instructions');
                const text = await res.text();
                webhookInstructionsText = text;
                document.getElementById('webhook-instructions').textContent = res.ok ? text : 'Error: ' + text;
            } catch (e) {
                webhookInstructionsText = '';
                document.getElementById('webhook-instructions').textContent = 'Failed to load instructions.';
            }
        }
        function closeWebhookModal() {
            document.getElementById('webhook-modal').classList.add('hidden');
        }
        function copyWebhookInstructions() {
            if (!webhookInstructionsText) return;
            navigator.clipboard.writeText(webhookInstructionsText).then(() => showToast('Copied to clipboard', 'success')).catch(() => showToast('Copy failed', 'error'));
        }

        function startDeployLogSSE(serviceName) {
            if (deployLogEventSource) deployLogEventSource.close();
            const viewer = document.getElementById('deploy-log-viewer');
            viewer.textContent = 'Starting log stream…';
            deployLogEventSource = new EventSource(API + '/sse/deploy-log/' + encodeURIComponent(serviceName));
            deployLogEventSource.addEventListener('log', function(e) {
                const text = typeof e.data === 'string' ? e.data : (e.data || '');
                viewer.textContent = viewer.textContent === 'Starting log stream…' || viewer.textContent === 'Connecting to log stream…' ? text : viewer.textContent + text;
                viewer.classList.remove('empty');
                viewer.scrollTop = viewer.scrollHeight;
            });
            deployLogEventSource.addEventListener('done', function() {
                if (deployLogEventSource) {
                    deployLogEventSource.close();
                    deployLogEventSource = null;
                }
            });
        }

        async function deployService(serviceName) {
            if (!confirm(`Deploy ${serviceName}?`)) return;
            openDeployModal(serviceName);
            try {
                const res = await fetch(API + '/deploy/' + encodeURIComponent(serviceName), { method: 'POST' });
                if (!res.ok) {
                    closeDeployModal();
                    showToast('Deploy request failed', 'error');
                    return;
                }
                showToast('Deploy started', 'info');
                startDeployLogSSE(serviceName);
                const checkDone = setInterval(async () => {
                    try {
                        const r = await fetch(API + '/deployments');
                        const data = await r.json();
                        const d = data.deployments && data.deployments[serviceName];
                        const status = d && d.status;
                        if (status && status !== 'deploying') {
                            clearInterval(checkDone);
                            closeDeployModal();
                            if (status === 'running') showToast(`${serviceName} deployed`, 'success');
                            else showToast(`${serviceName} deploy: ${status}`, 'error');
                            refreshData(false);
                        }
                    } catch (_) {}
                }, 3000);
                setTimeout(() => clearInterval(checkDone), 300000);
            } catch (e) {
                closeDeployModal();
                showToast('Error starting deploy', 'error');
            }
        }

        async function restartService(serviceName) {
            if (!confirm(`Restart ${serviceName}?`)) return;
            try {
                const res = await fetch(API + '/restart/' + encodeURIComponent(serviceName), { method: 'POST' });
                if (res.ok) {
                    showToast(`${serviceName} restarted`, 'success');
                    refreshData(false);
                } else showToast('Restart failed', 'error');
            } catch (_) { showToast('Restart failed', 'error'); }
        }

        async function removeDeployment(serviceName) {
            if (!confirm(`Remove ${serviceName}? This will stop the service and delete configuration.`)) return;
            try {
                const res = await fetch(API + '/deployments/' + encodeURIComponent(serviceName), { method: 'DELETE' });
                if (res.ok) {
                    showToast(`${serviceName} removed`, 'success');
                    refreshData(false);
                    if (document.getElementById('log-service-select').value === serviceName) {
                        document.getElementById('log-service-select').value = '';
                        stopLogStream();
                        document.getElementById('log-viewer').textContent = 'Select a service to stream logs.';
                        document.getElementById('log-viewer').classList.add('empty');
                    }
                } else showToast('Remove failed', 'error');
            } catch (_) { showToast('Remove failed', 'error'); }
        }

        function viewDeployLogs(serviceName) {
            openDeployModal(serviceName);
            startDeployLogSSE(serviceName);
        }

        function viewLogs(serviceName) {
            document.getElementById('log-service-select').value = serviceName;
            startLogStream();
            loadServiceLogs();
        }

        function startLogStream() {
            stopLogStream();
            const name = document.getElementById('log-service-select').value;
            if (!name) return;
            const viewer = document.getElementById('log-viewer');
            viewer.textContent = 'Connecting to log stream…';
            viewer.classList.remove('empty');
            document.getElementById('log-live-badge').textContent = 'Live';
            logsEventSource = new EventSource(API + '/sse/logs/' + encodeURIComponent(name));
            logsEventSource.addEventListener('log', function(e) {
                const text = typeof e.data === 'string' ? e.data : (e.data || '');
                viewer.textContent = viewer.textContent === 'Connecting to log stream…' ? text : viewer.textContent + text;
                viewer.scrollTop = viewer.scrollHeight;
            });
            logsEventSource.addEventListener('done', function() {});
            logsEventSource.addEventListener('error', function() {
                if (logsEventSource) {
                    logsEventSource.close();
                    logsEventSource = null;
                }
            });
        }

        function stopLogStream() {
            if (logsEventSource) {
                logsEventSource.close();
                logsEventSource = null;
            }
            document.getElementById('log-live-badge').textContent = '';
        }

        document.getElementById('log-service-select').addEventListener('change', function() {
            if (this.value) {
                startLogStream();
            } else {
                stopLogStream();
                document.getElementById('log-viewer').textContent = 'Select a service to stream logs.';
                document.getElementById('log-viewer').classList.add('empty');
            }
        });

        function showAddDeploymentForm() {
            showToast('Add deployment via CLI: api-manage-extended deploy add <name> <repo> <branch> <port>', 'info');
        }

        function showSystemInfo() {
            showToast('System info: use api-manage-extended status', 'info');
        }

        function showAiHelp() {
            showToast('Install AI: sudo api-manage-extended ai add ollama', 'info');
        }

        async function loadAiServices() {
            try {
                const res = await fetch(API + '/ai/services');
                const data = await res.json();
                const el = document.getElementById('ai-services-list');
                if (!data.services || data.services.length === 0) {
                    el.textContent = 'No AI models installed';
                    return;
                }
                el.innerHTML = data.services.map(s =>
                    `<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;">
                        <span>${escapeHtml(s.name)}</span>
                        <span class="badge ${s.running ? 'badge-running' : 'badge-stopped'}" style="font-size:0.6rem;">${s.running ? 'running' : 'stopped'}</span>
                    </div>`
                ).join('');
            } catch { document.getElementById('ai-services-list').textContent = 'Error loading'; }
        }

        // Load AI services on page load
        document.addEventListener('DOMContentLoaded', loadAiServices);
        setInterval(loadAiServices, 15000);
    </script>
</body>
</html>
